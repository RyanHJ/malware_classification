from collections import defaultdict
from os import listdir
from os.path import isfile, join
import os
import numpy

target_names= ["Ramnit", "Lollipop", "Kelihos_ver3","Vundo","Simda", "Tracur", "Kelihos_ver1", "Obfuscator.ACY","Gatak"]

def get_malware_dict(filename, return_string=True):
    """
    Extracts which maleware class the given filename is
    and builds a dictionary from the data.
    """
    malware_mappings = {}
    malware_mappings[1] = "Ramnit"
    malware_mappings[2] = "Lollipop"
    malware_mappings[3] = "Kelihos_ver3"
    malware_mappings[4] = "Vundo"
    malware_mappings[5] = "Simda"
    malware_mappings[6] = "Tracur"
    malware_mappings[7] = "Kelihos_ver1"
    malware_mappings[8] = "Obfuscator.ACY"
    malware_mappings[9] = "Gatak"

    file_to_malware = {}
    f = open(filename, 'r')
    for line in f.readlines()[1:]:
        split = line.split(',')
        (filename,mal_class) = split[0].replace('\"', ''), int(split[1])
        file_to_malware[filename] = mal_class
        
        # Return in string form
        if return_string:
            file_to_malware[filename] = malware_mappings[mal_class]

    return file_to_malware

def get_malware_class(file_in, file_to_malware):
    """
    Returns the malware classification of file
    """
    # Get just the filename without extension
    malware_filename = file_in.rsplit('/', 1)[1].split('.')[0]
    # Extract the malware class
    return file_to_malware[malware_filename]

def chunks(l, n):
    """Yield successive n-sized chunks from l."""
    for i in xrange(0, len(l), n):
        yield l[i:i+n]

def merge_dicts(dictionaries):
    result = defaultdict(int)
    for dictionary in dictionaries:
        for key,value in dictionary.iteritems():
            result[key] += value

    return result

def write_lines(lines):
    f = open('../data/features.csv', 'w')
    header = "malware_class,num_lines,num_fun_calls,num_unique_fun_calls"
    f.write(header)
    for line in lines:
        f.write(line)
    f.close()

def load_bytes(filename):
    byte_array = []
    for line in open(filename, 'r'):
        # Split on spaces
        line_split = line.split(' ', )
        
        # first element is memory address, we will ignore it. Append all bytes to byte_array
        line_split = map((lambda x: x.replace('\r', '').replace('\n', '')), line_split)
        byte_array = byte_array + line_split[1:]

    return byte_array

#messy function...
def process_file_folder(folder,file_type,file_function,move_location,file_to_malware):
    #### Get a list of all file_type files######
    files = [ f for f in listdir(folder) if isfile(join(folder,f)) and f.endswith(file_type)]

    count = 1
    for file in files:
        print("******* Processing {0} ({1}/{2})********".format(file,count,len(files)))
        count += 1

        file_in = join(folder,file)
        new_loc = join(move_location,file)
        
        file_function(file_in, file_to_malware)        
        #extract_columns(file_in, '',file_to_malware)
        
        os.rename(file_in, new_loc)

def calculate_dft(bytes_array):
    return numpy.fft.fft(bytes_array)
